<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Theo d√µi giao d·ªãch Solana</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .filter-section {
            background: white;
            padding: 25px 30px;
            border-bottom: 2px solid #e9ecef;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 13px;
            font-weight: 600;
            color: #495057;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card .label {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .table-container {
            padding: 30px;
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .table-header h3 {
            color: #495057;
            margin: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin-bottom: 20px;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            font-size: 13px;
        }

        tbody tr {
            transition: background 0.3s;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .address {
            font-family: monospace;
            font-size: 12px;
            color: #667eea;
            cursor: pointer;
        }

        .address:hover {
            text-decoration: underline;
        }

        .sol-amount {
            font-weight: bold;
            color: #28a745;
            font-size: 14px;
        }

        .signature {
            font-family: monospace;
            font-size: 11px;
            color: #6c757d;
            cursor: pointer;
        }

        .signature:hover {
            color: #667eea;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-transfer {
            background: #d1ecf1;
            color: #0c5460;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 20px;
        }

        .pagination button {
            padding: 8px 15px;
            border: 1px solid #e9ecef;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            padding: 8px 15px;
            font-weight: 600;
            color: #495057;
        }

        .last-update {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-size: 13px;
        }

        .storage-info {
            background: #e7f3ff;
            padding: 15px;
            margin: 15px 30px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .storage-info .info {
            font-size: 13px;
            color: #004085;
        }

        .storage-info .clear-btn {
            padding: 6px 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .storage-info .clear-btn:hover {
            background: #c82333;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #495057;
        }

        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }

        .modal-close:hover {
            color: #000;
        }

        .filter-results {
            background: #fff3cd;
            padding: 15px;
            margin: 15px 30px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            display: none;
        }

        .filter-results.active {
            display: block;
        }

        .filter-results h4 {
            color: #856404;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Dashboard Theo D√µi Giao D·ªãch Solana</h1>
            <p>Theo d√µi v√† ph√¢n t√≠ch giao d·ªãch chi ti·∫øt</p>
        </div>

        <div class="filter-section">
            <h3 style="margin-bottom: 15px; color: #495057;">üîç L·∫•y d·ªØ li·ªáu giao d·ªãch</h3>
            
            <!-- Nh·∫≠p ƒë·ªãa ch·ªâ v√≠ -->
            <div class="filter-grid">
                <div class="filter-group">
                    <label>ƒê·ªãa ch·ªâ v√≠ *</label>
                    <input type="text" id="walletInput" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ v√≠ Solana" value="5tzFkiKscXHK5ZXCGbXZxdw7gTjjD1mBwuoFbhUvuAi9">
                </div>
            </div>

            <div class="filter-actions">
                <button class="btn btn-primary" onclick="fetchLatestTransactions()">üîÑ L·∫•y giao d·ªãch 1 ng√†y g·∫ßn nh·∫•t</button>
                <button class="btn btn-warning" onclick="showLoadOldModal()">‚è≥ L·∫•y giao d·ªãch c≈© theo ng√†y</button>
                <button class="btn btn-secondary" onclick="clearStorage()">üóëÔ∏è X√≥a d·ªØ li·ªáu</button>
            </div>

            <hr style="margin: 25px 0; border: none; border-top: 2px solid #e9ecef;">

            <h3 style="margin-bottom: 15px; color: #495057;">üîç L·ªçc d·ªØ li·ªáu ƒë√£ t·∫£i</h3>
            
            <!-- Filter -->
            <div class="filter-grid">
                <div class="filter-group">
                    <label>SOL t·ª´</label>
                    <input type="number" id="minSol" placeholder="0" step="0.1" min="0">
                </div>
                <div class="filter-group">
                    <label>SOL ƒë·∫øn</label>
                    <input type="number" id="maxSol" placeholder="Kh√¥ng gi·ªõi h·∫°n" step="0.1" min="0">
                </div>
            </div>

            <div class="filter-grid" style="grid-template-columns: 1fr 1fr; margin-top: 15px;">
                <div class="filter-group">
                    <label>üìÖ From Date</label>
                    <input type="date" id="fromDate">
                </div>
                <div class="filter-group">
                    <label>üìÖ To Date</label>
                    <input type="date" id="toDate">
                </div>
            </div>
            
            <div class="filter-grid" style="grid-template-columns: 1fr 1fr; margin-top: 15px;">
                <div class="filter-group">
                    <label>üïê From Time (HH:MM)</label>
                    <input type="time" id="fromTime">
                </div>
                <div class="filter-group">
                    <label>üïê To Time (HH:MM)</label>
                    <input type="time" id="toTime">
                </div>
            </div>

            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()">√Åp d·ª•ng Filter</button>
                <button class="btn btn-secondary" onclick="resetFilters()">Reset Filter</button>
            </div>
        </div>

        <!-- Filter Results Banner -->
        <div id="filterResultsBanner" class="filter-results">
            <h4>üîç K·∫øt qu·∫£ l·ªçc</h4>
            <div id="filterResultsText"></div>
        </div>

        <div class="storage-info">
            <div class="info">
                üíæ T·ªïng d·ªØ li·ªáu: <strong id="storedCount">0</strong> giao d·ªãch | 
                üìä ƒêang hi·ªÉn th·ªã: <strong id="displayCount">0</strong> giao d·ªãch
            </div>
        </div>

        <!-- Filtered Table (appears when filter is applied) -->
        <div id="filteredTableContainer" style="display: none;">
            <div class="table-container">
                <div class="table-header">
                    <h3>üìã K·∫øt qu·∫£ l·ªçc</h3>
                    <button class="btn btn-secondary" onclick="exportData('filtered')">üíæ Export CSV</button>
                </div>
                <table id="filteredTable">
                    <thead>
                        <tr>
                            <th>Ng√†y gi·ªù</th>
                            <th>Lo·∫°i</th>
                            <th>S·ªë SOL</th>
                            <th>ƒê·∫øn ƒë·ªãa ch·ªâ</th>
                            <th>Signature</th>
                        </tr>
                    </thead>
                    <tbody id="filteredTxBody">
                    </tbody>
                </table>
                <div class="pagination">
                    <button onclick="changeFilteredPage(-1)" id="prevFilteredBtn">‚¨ÖÔ∏è Tr∆∞·ªõc</button>
                    <span class="page-info">Trang <strong id="currentFilteredPage">1</strong> / <strong id="totalFilteredPages">1</strong></span>
                    <button onclick="changeFilteredPage(1)" id="nextFilteredBtn">Ti·∫øp ‚û°Ô∏è</button>
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="label">T·ªïng giao d·ªãch</div>
                <div class="value" id="totalTxs">-</div>
            </div>
            <div class="stat-card">
                <div class="label">T·ªïng SOL</div>
                <div class="value" id="totalSol">-</div>
            </div>
            <div class="stat-card">
                <div class="label">Trung b√¨nh</div>
                <div class="value" id="avgSol">-</div>
            </div>
            <div class="stat-card">
                <div class="label">Giao d·ªãch m·ªõi nh·∫•t</div>
                <div class="value" id="latestTime">-</div>
            </div>
        </div>

        <!-- Main Data Table (auto-refresh) -->
        <div class="table-container">
            <div class="table-header">
                <h3>üìä D·ªØ li·ªáu Real-time (T·ª± ƒë·ªông c·∫≠p nh·∫≠t m·ªói 30s)</h3>
                <button class="btn btn-secondary" onclick="exportData('all')">üíæ Export CSV</button>
            </div>
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
            </div>
            <table id="txTable">
                <thead>
                    <tr>
                        <th>Ng√†y gi·ªù</th>
                        <th>Lo·∫°i</th>
                        <th>S·ªë SOL</th>
                        <th>ƒê·∫øn ƒë·ªãa ch·ªâ</th>
                        <th>Signature</th>
                    </tr>
                </thead>
                <tbody id="txBody">
                </tbody>
            </table>
        </div>

        <div class="pagination">
            <button onclick="changePage(-1)" id="prevBtn">‚¨ÖÔ∏è Tr∆∞·ªõc</button>
            <span class="page-info">Trang <strong id="currentPage">1</strong> / <strong id="totalPages">1</strong></span>
            <button onclick="changePage(1)" id="nextBtn">Ti·∫øp ‚û°Ô∏è</button>
        </div>

        <div class="last-update" id="lastUpdate"></div>
    </div>

    <!-- Modal l·∫•y giao d·ªãch c≈© -->
    <div id="oldTxModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeLoadOldModal()">&times;</span>
            <h3>‚è≥ L·∫•y giao d·ªãch c≈© theo ng√†y</h3>
            
            <div class="filter-group" style="margin-bottom: 15px;">
                <label>üìÖ Ch·ªçn ng√†y c·∫ßn l·∫•y data</label>
                <input type="date" id="oldDate">
            </div>
            
            <div class="filter-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="filter-group">
                    <label>üïê T·ª´ gi·ªù (HH:MM)</label>
                    <input type="time" id="oldFromTime" value="00:00">
                </div>
                <div class="filter-group">
                    <label>üïê ƒê·∫øn gi·ªù (HH:MM)</label>
                    <input type="time" id="oldToTime" value="23:59">
                </div>
            </div>
            
            <div class="filter-actions" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="fetchOldTransactions()">üì• L·∫•y d·ªØ li·ªáu</button>
                <button class="btn btn-secondary" onclick="closeLoadOldModal()">H·ªßy</button>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = '372ee7db-c6f7-4b68-9f2b-fd12c97d390b';
        const STORAGE_KEY = 'solana_transactions';
        const ITEMS_PER_PAGE_MAIN = 25; // B·∫£ng ch√≠nh 25/trang
        const ITEMS_PER_PAGE_FILTERED = 50; // B·∫£ng filter 50/trang
        const AUTO_REFRESH_INTERVAL = 30000; // 30 seconds
        
        let allTransactions = [];
        let filteredTransactions = [];
        let currentPage = 1;
        let currentFilteredPage = 1;
        let autoRefreshTimer = null;
        let lastTransactionSignature = null;
        let isFilterActive = false;

        // Load d·ªØ li·ªáu t·ª´ localStorage
        function loadFromStorage() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                allTransactions = JSON.parse(stored);
                console.log(`üì¶ Loaded ${allTransactions.length} transactions from storage`);
            }
        }

        // L∆∞u v√†o localStorage
        function saveToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allTransactions));
            updateStorageInfo();
        }

        // X√≥a localStorage
        function clearStorage() {
            if (confirm('‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu ƒë√£ l∆∞u?')) {
                stopAutoRefresh();
                localStorage.removeItem(STORAGE_KEY);
                allTransactions = [];
                filteredTransactions = [];
                currentPage = 1;
                currentFilteredPage = 1;
                lastTransactionSignature = null;
                isFilterActive = false;
                renderMainTable();
                updateStats();
                updateStorageInfo();
                hideFilteredTable();
                alert('‚úÖ ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu!');
            }
        }

        // C·∫≠p nh·∫≠t storage info
        function updateStorageInfo() {
            document.getElementById('storedCount').textContent = allTransactions.length;
            document.getElementById('displayCount').textContent = isFilterActive ? filteredTransactions.length : allTransactions.length;
        }

        // Auto-refresh function - T·ª∞ ƒê·ªòNG C·∫¨P NH·∫¨T KH√îNG TH√îNG B√ÅO
        async function checkForNewTransactions() {
            const wallet = document.getElementById('walletInput').value.trim();
            if (!wallet || allTransactions.length === 0) return;

            try {
                const url = `https://api.helius.xyz/v0/addresses/${wallet}/transactions?api-key=${API_KEY}&limit=10`;
                const response = await fetch(url);
                if (!response.ok) return;
                
                const data = await response.json();
                if (data.length === 0) return;

                const newestSignature = data[0].signature;
                if (lastTransactionSignature && newestSignature !== lastTransactionSignature) {
                    console.log('üîî Ph√°t hi·ªán giao d·ªãch m·ªõi - ƒëang c·∫≠p nh·∫≠t t·ª± ƒë·ªông...');
                    
                    // T√¨m giao d·ªãch m·ªõi
                    let newTxs = [];
                    for (const tx of data) {
                        if (tx.signature === lastTransactionSignature) break;
                        newTxs.push(tx);
                    }
                    
                    // Process v√† th√™m v√†o ƒë·∫ßu
                    const processedNewTxs = processTransactions(newTxs);
                    const existingSignatures = new Set(allTransactions.map(tx => tx.signature));
                    const uniqueNewTxs = processedNewTxs.filter(tx => !existingSignatures.has(tx.signature));
                    
                    if (uniqueNewTxs.length > 0) {
                        allTransactions = [...uniqueNewTxs, ...allTransactions];
                        saveToStorage();
                        
                        // C·∫≠p nh·∫≠t b·∫£ng ch√≠nh
                        renderMainTable();
                        updateStats();
                        
                        console.log(`‚úÖ ƒê√£ t·ª± ƒë·ªông th√™m ${uniqueNewTxs.length} giao d·ªãch m·ªõi`);
                    }
                }
                
                lastTransactionSignature = newestSignature;
            } catch (error) {
                console.error('Auto-refresh error:', error);
            }
        }

        // Start auto-refresh
        function startAutoRefresh() {
            if (autoRefreshTimer) clearInterval(autoRefreshTimer);
            autoRefreshTimer = setInterval(checkForNewTransactions, AUTO_REFRESH_INTERVAL);
            console.log('‚úÖ T·ª± ƒë·ªông ki·ªÉm tra m·ªói 30s');
        }

        // Stop auto-refresh
        function stopAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
        }

        // L·∫•y giao d·ªãch 1 ng√†y g·∫ßn nh·∫•t
        async function fetchLatestTransactions() {
            const wallet = document.getElementById('walletInput').value.trim();
            if (!wallet) {
                alert('‚ùå Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ v√≠!');
                return;
            }

            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            try {
                // Calculate 1 day ago timestamp
                const oneDayAgo = Math.floor(Date.now() / 1000) - (24 * 60 * 60);
                
                let allFetchedTxs = [];
                let before = null;
                let page = 1;
                let keepFetching = true;

                while (keepFetching) {
                    let url = `https://api.helius.xyz/v0/addresses/${wallet}/transactions?api-key=${API_KEY}&limit=100`;
                    if (before) url += `&before=${before}`;

                    console.log(`üì• Fetching page ${page}...`);
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    
                    const data = await response.json();
                    if (data.length === 0) break;

                    // Check if we've reached transactions older than 1 day
                    const oldestTimestamp = data[data.length - 1].timestamp;
                    if (oldestTimestamp < oneDayAgo) {
                        // Filter only transactions from last 24h
                        const recentTxs = data.filter(tx => tx.timestamp >= oneDayAgo);
                        allFetchedTxs.push(...recentTxs);
                        keepFetching = false;
                        console.log('‚úÖ ƒê√£ l·∫•y h·∫øt giao d·ªãch trong 1 ng√†y');
                    } else {
                        allFetchedTxs.push(...data);
                        before = data[data.length - 1].signature;
                        page++;
                    }

                    // Safety limit
                    if (page > 50) break;
                }

                // Process transactions
                const newTxs = processTransactions(allFetchedTxs);
                
                // Merge with existing data (remove duplicates)
                const existingSignatures = new Set(allTransactions.map(tx => tx.signature));
                const uniqueNewTxs = newTxs.filter(tx => !existingSignatures.has(tx.signature));
                
                allTransactions = [...uniqueNewTxs, ...allTransactions];
                allTransactions.sort((a, b) => b.timestamp - a.timestamp);

                if (allTransactions.length > 0) {
                    lastTransactionSignature = allTransactions[0].signature;
                }

                saveToStorage();
                renderMainTable();
                updateStats();
                startAutoRefresh();
                
                alert(`‚úÖ ƒê√£ t·∫£i ${uniqueNewTxs.length} giao d·ªãch m·ªõi trong 24h g·∫ßn nh·∫•t!`);
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        // Show modal l·∫•y giao d·ªãch c≈©
        function showLoadOldModal() {
            document.getElementById('oldTxModal').style.display = 'block';
            // Set default date to yesterday
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 2);
            document.getElementById('oldDate').valueAsDate = yesterday;
        }

        // Close modal
        function closeLoadOldModal() {
            document.getElementById('oldTxModal').style.display = 'none';
        }

        // L·∫•y giao d·ªãch c≈© theo ng√†y v√† gi·ªù
        async function fetchOldTransactions() {
            const wallet = document.getElementById('walletInput').value.trim();
            if (!wallet) {
                alert('‚ùå Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ v√≠!');
                return;
            }

            const dateStr = document.getElementById('oldDate').value;
            if (!dateStr) {
                alert('‚ùå Vui l√≤ng ch·ªçn ng√†y!');
                return;
            }

            const fromTime = document.getElementById('oldFromTime').value || '00:00';
            const toTime = document.getElementById('oldToTime').value || '23:59';

            // Parse datetime
            const fromDateTime = new Date(`${dateStr}T${fromTime}:00`);
            const toDateTime = new Date(`${dateStr}T${toTime}:59`);
            const fromTimestamp = Math.floor(fromDateTime.getTime() / 1000);
            const toTimestamp = Math.floor(toDateTime.getTime() / 1000);

            console.log('Fetching from:', fromDateTime.toLocaleString('vi-VN'));
            console.log('Fetching to:', toDateTime.toLocaleString('vi-VN'));

            closeLoadOldModal();
            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            try {
                let allFetchedTxs = [];
                let before = null;
                let page = 1;
                let keepFetching = true;

                while (keepFetching) {
                    let url = `https://api.helius.xyz/v0/addresses/${wallet}/transactions?api-key=${API_KEY}&limit=100`;
                    if (before) url += `&before=${before}`;

                    console.log(`üì• Fetching page ${page}...`);
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    
                    const data = await response.json();
                    if (data.length === 0) break;

                    // Check timestamps
                    const oldestTimestamp = data[data.length - 1].timestamp;
                    
                    if (oldestTimestamp > toTimestamp) {
                        // Still haven't reached target date, keep going
                        before = data[data.length - 1].signature;
                        page++;
                    } else if (oldestTimestamp >= fromTimestamp) {
                        // We're in the target range
                        const filteredTxs = data.filter(tx => 
                            tx.timestamp >= fromTimestamp && tx.timestamp <= toTimestamp
                        );
                        allFetchedTxs.push(...filteredTxs);
                        
                        if (oldestTimestamp < fromTimestamp) {
                            keepFetching = false;
                            console.log('‚úÖ ƒê√£ l·∫•y h·∫øt giao d·ªãch trong khung gi·ªù');
                        } else {
                            before = data[data.length - 1].signature;
                            page++;
                        }
                    } else {
                        // We've gone past the target date
                        keepFetching = false;
                        console.log('‚úÖ ƒê√£ qua khung gi·ªù c·∫ßn t√¨m');
                    }

                    // Safety limit
                    if (page > 100) {
                        console.log('‚ö†Ô∏è ƒê√£ ƒë·∫°t gi·ªõi h·∫°n trang');
                        break;
                    }
                }

                // Process transactions
                const newTxs = processTransactions(allFetchedTxs);
                
                // Merge with existing data
                const existingSignatures = new Set(allTransactions.map(tx => tx.signature));
                const uniqueNewTxs = newTxs.filter(tx => !existingSignatures.has(tx.signature));
                
                allTransactions = [...allTransactions, ...uniqueNewTxs];
                allTransactions.sort((a, b) => b.timestamp - a.timestamp);

                saveToStorage();
                renderMainTable();
                updateStats();
                
                alert(`‚úÖ ƒê√£ t·∫£i th√™m ${uniqueNewTxs.length} giao d·ªãch c≈© t·ª´ ${fromDateTime.toLocaleString('vi-VN')} ƒë·∫øn ${toDateTime.toLocaleString('vi-VN')}!`);
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        // Process transactions helper
        function processTransactions(txArray) {
            const processed = [];
            
            for (const tx of txArray) {
                if (!tx.nativeTransfers) continue;
                
                for (const transfer of tx.nativeTransfers) {
                    const solAmount = transfer.amount / 1_000_000_000;
                    const date = new Date(tx.timestamp * 1000);
                    
                    const hours = date.getHours();
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    const period = hours < 12 ? 'SA' : 'CH';
                    const displayHour = hours === 0 ? 12 : (hours > 12 ? hours - 12 : hours);
                    
                    processed.push({
                        timestamp: tx.timestamp,
                        datetime: `${displayHour}:${minutes} ${period} ${day}/${month}/${year}`,
                        date: date.toISOString().split('T')[0],
                        time: `${String(hours).padStart(2, '0')}:${minutes}`,
                        type: tx.type,
                        solAmount: solAmount,
                        toAddress: transfer.toUserAccount,
                        signature: tx.signature
                    });
                }
            }
            
            return processed;
        }

        // √Åp d·ª•ng filter
        function applyFilters() {
            const minSol = parseFloat(document.getElementById('minSol').value) || 0;
            const maxSol = parseFloat(document.getElementById('maxSol').value) || Infinity;
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const fromTime = document.getElementById('fromTime').value;
            const toTime = document.getElementById('toTime').value;

            // Check if any filter is active
            const hasActiveFilter = minSol > 0 || maxSol < Infinity || fromDate || toDate || fromTime || toTime;

            if (!hasActiveFilter) {
                hideFilteredTable();
                return;
            }

            console.log('Applying filters:', { minSol, maxSol, fromDate, toDate, fromTime, toTime });

            filteredTransactions = allTransactions.filter(tx => {
                // Filter SOL
                if (tx.solAmount < minSol || tx.solAmount > maxSol) return false;
                
                // Filter date range
                if (fromDate && tx.date < fromDate) return false;
                if (toDate && tx.date > toDate) return false;
                
                // Filter time range
                if (fromTime || toTime) {
                    const [txHour, txMinute] = tx.time.split(':').map(Number);
                    const txTimeInMinutes = txHour * 60 + txMinute;
                    
                    if (fromTime) {
                        const [fh, fm] = fromTime.split(':').map(Number);
                        const fromTimeInMinutes = fh * 60 + fm;
                        if (txTimeInMinutes < fromTimeInMinutes) return false;
                    }
                    
                    if (toTime) {
                        const [th, tm] = toTime.split(':').map(Number);
                        const toTimeInMinutes = th * 60 + tm;
                        if (txTimeInMinutes > toTimeInMinutes) return false;
                    }
                }
                
                return true;
            });

            console.log(`Filtered: ${filteredTransactions.length} / ${allTransactions.length}`);

            isFilterActive = true;
            currentFilteredPage = 1;
            showFilteredTable();
            renderFilteredTable();
            updateStorageInfo();
        }

        function resetFilters() {
            document.getElementById('minSol').value = '';
            document.getElementById('maxSol').value = '';
            document.getElementById('fromDate').value = '';
            document.getElementById('toDate').value = '';
            document.getElementById('fromTime').value = '';
            document.getElementById('toTime').value = '';
            
            hideFilteredTable();
        }

        function showFilteredTable() {
            document.getElementById('filteredTableContainer').style.display = 'block';
            document.getElementById('filterResultsBanner').classList.add('active');
            document.getElementById('filterResultsText').textContent = `T√¨m th·∫•y ${filteredTransactions.length} giao d·ªãch ph√π h·ª£p v·ªõi ƒëi·ªÅu ki·ªán l·ªçc`;
        }

        function hideFilteredTable() {
            document.getElementById('filteredTableContainer').style.display = 'none';
            document.getElementById('filterResultsBanner').classList.remove('active');
            isFilterActive = false;
            filteredTransactions = [];
            updateStorageInfo();
        }

        // Render b·∫£ng ch√≠nh (real-time data) - 25 items per page
        function renderMainTable() {
            const tbody = document.getElementById('txBody');
            tbody.innerHTML = '';

            const totalPages = Math.ceil(allTransactions.length / ITEMS_PER_PAGE_MAIN);
            const start = (currentPage - 1) * ITEMS_PER_PAGE_MAIN;
            const end = start + ITEMS_PER_PAGE_MAIN;
            const pageData = allTransactions.slice(start, end);

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6c757d; padding: 40px;">Kh√¥ng c√≥ d·ªØ li·ªáu. Vui l√≤ng t·∫£i d·ªØ li·ªáu tr∆∞·ªõc!</td></tr>';
            } else {
                pageData.forEach(tx => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${tx.datetime}</td>
                        <td><span class="badge badge-transfer">${tx.type}</span></td>
                        <td><span class="sol-amount">${tx.solAmount.toFixed(4)} SOL</span></td>
                        <td><span class="address" onclick="copyToClipboard('${tx.toAddress}')" title="Click ƒë·ªÉ copy">${tx.toAddress}</span></td>
                        <td><a href="https://solscan.io/tx/${tx.signature}" target="_blank" class="signature" title="Xem tr√™n Solscan">${tx.signature.slice(0,16)}...${tx.signature.slice(-16)}</a></td>
                    `;
                });
            }

            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages || 1;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
            
            updateStats();
        }

        // Render b·∫£ng filtered - 50 items per page
        function renderFilteredTable() {
            const tbody = document.getElementById('filteredTxBody');
            tbody.innerHTML = '';

            const totalPages = Math.ceil(filteredTransactions.length / ITEMS_PER_PAGE_FILTERED);
            const start = (currentFilteredPage - 1) * ITEMS_PER_PAGE_FILTERED;
            const end = start + ITEMS_PER_PAGE_FILTERED;
            const pageData = filteredTransactions.slice(start, end);

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6c757d; padding: 40px;">Kh√¥ng t√¨m th·∫•y giao d·ªãch ph√π h·ª£p!</td></tr>';
            } else {
                pageData.forEach(tx => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${tx.datetime}</td>
                        <td><span class="badge badge-transfer">${tx.type}</span></td>
                        <td><span class="sol-amount">${tx.solAmount.toFixed(4)} SOL</span></td>
                        <td><span class="address" onclick="copyToClipboard('${tx.toAddress}')" title="Click ƒë·ªÉ copy">${tx.toAddress}</span></td>
                        <td><a href="https://solscan.io/tx/${tx.signature}" target="_blank" class="signature" title="Xem tr√™n Solscan">${tx.signature.slice(0,16)}...${tx.signature.slice(-16)}</a></td>
                    `;
                });
            }

            document.getElementById('currentFilteredPage').textContent = currentFilteredPage;
            document.getElementById('totalFilteredPages').textContent = totalPages || 1;
            document.getElementById('prevFilteredBtn').disabled = currentFilteredPage === 1;
            document.getElementById('nextFilteredBtn').disabled = currentFilteredPage >= totalPages;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(allTransactions.length / ITEMS_PER_PAGE_MAIN);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderMainTable();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function changeFilteredPage(direction) {
            const totalPages = Math.ceil(filteredTransactions.length / ITEMS_PER_PAGE_FILTERED);
            const newPage = currentFilteredPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentFilteredPage = newPage;
                renderFilteredTable();
                window.scrollTo({ top: document.getElementById('filteredTableContainer').offsetTop - 100, behavior: 'smooth' });
            }
        }

        function updateStats() {
            const displayData = allTransactions;
            
            document.getElementById('totalTxs').textContent = displayData.length;
            
            const totalSol = displayData.reduce((sum, tx) => sum + tx.solAmount, 0);
            document.getElementById('totalSol').textContent = totalSol.toFixed(2);
            
            const avgSol = displayData.length > 0 ? totalSol / displayData.length : 0;
            document.getElementById('avgSol').textContent = avgSol.toFixed(4);
            
            if (displayData.length > 0) {
                const latestDate = displayData[0].datetime.split(' ').slice(2).join(' ');
                document.getElementById('latestTime').textContent = latestDate;
            } else {
                document.getElementById('latestTime').textContent = '-';
            }

            document.getElementById('lastUpdate').textContent = 
                `C·∫≠p nh·∫≠t l√∫c: ${new Date().toLocaleString('vi-VN')}`;
        }

        function exportData(type) {
            const dataToExport = type === 'filtered' ? filteredTransactions : allTransactions;
            
            if (dataToExport.length === 0) {
                alert('‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ export!');
                return;
            }

            let csv = 'Ng√†y gi·ªù,Lo·∫°i,S·ªë SOL,ƒê·∫øn ƒë·ªãa ch·ªâ,Signature\n';
            dataToExport.forEach(tx => {
                csv += `"${tx.datetime}","${tx.type}",${tx.solAmount},"${tx.toAddress}","${tx.signature}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `solana_tx_${type}_${Date.now()}.csv`;
            link.click();

            alert(`‚úÖ ƒê√£ export ${dataToExport.length} giao d·ªãch!`);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Silent copy - no alert
                console.log('‚úÖ Copied:', text);
            });
        }

        // Kh·ªüi ƒë·ªông
        window.onload = function() {
            loadFromStorage();
            if (allTransactions.length > 0) {
                lastTransactionSignature = allTransactions[0].signature;
                renderMainTable();
                updateStats();
                updateStorageInfo();
                startAutoRefresh();
                console.log('‚úÖ Loaded data from storage and started auto-refresh');
            } else {
                renderMainTable();
                updateStats();
                updateStorageInfo();
                console.log('‚ÑπÔ∏è No data. Please fetch transactions.');
            }
        };

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('oldTxModal');
            if (event.target == modal) {
                closeLoadOldModal();
            }
        };
    </script>
</body>
</html>